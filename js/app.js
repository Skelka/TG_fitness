// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let tg, mainButton, backButton, currentPeriod, weightChart;

// –î–æ–±–∞–≤–∏–º –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø–æ–ø–∞–ø–æ–≤
const popupQueue = [];
let isPopupShowing = false;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', async () => {
    try {
        // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp
        await new Promise(resolve => {
            if (window.Telegram?.WebApp) {
                resolve();
            } else {
                const maxAttempts = 10;
                let attempts = 0;
                const interval = setInterval(() => {
                    attempts++;
                    if (window.Telegram?.WebApp) {
                        clearInterval(interval);
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(interval);
                        throw new Error('Telegram WebApp –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                    }
                }, 100);
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        tg = window.Telegram.WebApp;
        mainButton = tg.MainButton;
        backButton = tg.BackButton;
        currentPeriod = 'week';

        // –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ WebApp
        tg.ready();
        tg.expand();
        tg.enableClosingConfirmation();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º
        if (!window.programData) {
            throw new Error('–î–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
        }

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
        mainButton.setText('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å');
        mainButton.hide();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Chart.js
        if (typeof Chart === 'undefined') {
            throw new Error('Chart.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        setupEventListeners();
        setupProgramHandlers();
        setupPopupHandlers();
        loadProfile();
        loadActiveProgram();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        await updateStatistics();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤–µ—Å–∞
        const weightData = await getWeightData('week');
        if (weightData && weightData.length > 0) {
            updateWeightChart(weightData);
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–∏–æ–¥–∞
        setupPeriodButtons();

        console.log('–í–µ—Ä—Å–∏—è WebApp:', tg.version);
        console.log('–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:', tg.platform);
        console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebApp:', tg.initData);
        console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã WebApp:', Object.keys(tg));

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
    }
});

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å CloudStorage
async function getStorageItem(key) {
    return new Promise((resolve) => {
        if (!tg?.CloudStorage) {
            console.warn('CloudStorage –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage');
            resolve(localStorage.getItem(key));
            return;
        }
        tg.CloudStorage.getItem(key, (error, value) => {
            if (error) {
                console.warn(`–û—à–∏–±–∫–∞ CloudStorage, –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage –¥–ª—è ${key}:`, error);
                resolve(localStorage.getItem(key));
            } else {
                resolve(value);
            }
        });
    });
}

async function setStorageItem(key, value) {
    return new Promise((resolve) => {
        if (!tg?.CloudStorage) {
            console.warn('CloudStorage –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage');
            localStorage.setItem(key, value);
            resolve(true);
            return;
        }
        tg.CloudStorage.setItem(key, value, (error, success) => {
            if (error || !success) {
                console.warn(`–û—à–∏–±–∫–∞ CloudStorage, –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage –¥–ª—è ${key}:`, error);
                localStorage.setItem(key, value);
                resolve(true);
            } else {
                resolve(success);
            }
        });
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è
async function loadProfile() {
    try {
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
        const user = tg.initDataUnsafe?.user;
        if (user) {
            document.getElementById('profile-name').textContent = user.first_name;
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è
            if (user.photo_url) {
                updateProfilePhoto(user.photo_url);
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
        const result = await getStorageItem('profile');
        if (result) {
            const profile = JSON.parse(result);
            fillProfileForm(profile);
            updateProfileStatus(profile);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è:', error);
        showError(error);
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—Ñ–∏–ª—è
function updateProfileStatus(profile) {
    const statusElement = document.querySelector('.profile-status');
    if (!statusElement) return;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ñ–∏–ª—è –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    let status = '–ù–æ–≤–∏—á–æ–∫';
    if (profile.completedWorkouts > 20) {
        status = '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π';
    } else if (profile.completedWorkouts > 5) {
        status = '–û–ø—ã—Ç–Ω—ã–π';
    }
    statusElement.textContent = status;
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
async function saveProfile() {
    try {
        mainButton.setText('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
        mainButton.showProgress();

        const form = document.getElementById('profile-form');
        const formData = new FormData(form);

        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
        const profileData = {
            age: parseInt(formData.get('age')) || 0,
            gender: formData.get('gender'),
            height: parseFloat(formData.get('height')) || 0,
            weight: parseFloat(formData.get('weight')) || 0,
            goal: formData.get('goal'),
            level: formData.get('level'),
            workoutPlaces: formData.getAll('workout_place'),
            equipment: formData.getAll('equipment'),
            lastUpdated: Date.now()
        };

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
        await setStorageItem('profile', JSON.stringify(profileData));

        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        updateProfileStatus(profileData);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        tg.HapticFeedback.notificationOccurred('success');
        mainButton.hideProgress();
        mainButton.setText('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úì');
        setTimeout(() => {
            mainButton.setText('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å');
        }, 2000);

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', error);
        mainButton.hideProgress();
        mainButton.setText('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å');
        showError(error);
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function showError(error) {
    tg.HapticFeedback.notificationOccurred('error');
    tg.showPopup({
        title: '–û—à–∏–±–∫–∞',
        message: error.message,
        buttons: [{type: 'ok'}]
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –ø—Ä–æ—Ñ–∏–ª—è
function fillProfileForm(profile) {
    const form = document.getElementById('profile-form');
    if (!form) return;

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
    const fields = ['age', 'gender', 'height', 'weight'];
    fields.forEach(field => {
        const input = form.querySelector(`[name="${field}"]`);
        if (input) {
            input.value = profile[field] || '';
        }
    });

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ü–µ–ª—å (—Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–∫–∏)
    if (profile.goal) {
        const goalInput = form.querySelector(`input[name="goal"][value="${profile.goal}"]`);
        if (goalInput) {
            goalInput.checked = true;
        }
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–µ—Å—Ç–∞ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    if (profile.workoutPlaces) {
        const workoutPlaceInputs = form.querySelectorAll('input[name="workout_place"]');
        workoutPlaceInputs.forEach(input => {
            input.checked = profile.workoutPlaces.includes(input.value);
        });
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
    if (profile.equipment) {
        const equipmentInputs = form.querySelectorAll('input[name="equipment"]');
        equipmentInputs.forEach(input => {
            input.checked = profile.equipment.includes(input.value);
        });
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
    if (profile.level) {
        const levelInput = form.querySelector(`input[name="level"][value="${profile.level}"]`);
        if (levelInput) {
            levelInput.checked = true;
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤–µ—Å–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥
async function getWeightData(period) {
    try {
        const result = await getStorageItem('weightHistory');
        const weightHistory = result ? JSON.parse(result) : [];
        
        const now = new Date();
        let startDate;
        
        switch(period) {
            case 'week':
                // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—á–∞–ª–æ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
                startDate = new Date(now);
                startDate.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1));
                startDate.setHours(0, 0, 0, 0);
                break;
            case 'month':
                // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                break;
            case 'year':
                // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å —Ç–µ–∫—É—â–µ–≥–æ –≥–æ–¥–∞
                startDate = new Date(now.getFullYear(), 0, 1);
                break;
            default:
                startDate = new Date(0);
        }

        // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –≤—Å–µ—Ö –¥–∞—Ç –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ
        const dates = [];
        const currentDate = new Date(startDate);
        
        while (currentDate <= now) {
            dates.push(new Date(currentDate));
            currentDate.setDate(currentDate.getDate() + 1);
        }

        // –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å –¥–∞—Ç–∞–º–∏
        return dates.map(date => {
            const entry = weightHistory.find(entry => {
                const entryDate = new Date(entry.date);
                return entryDate.getDate() === date.getDate() &&
                       entryDate.getMonth() === date.getMonth() &&
                       entryDate.getFullYear() === date.getFullYear();
            });
            
            return {
                date: date.toISOString(),
                weight: entry ? entry.weight : null
            };
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤–µ—Å–∞:', error);
        return [];
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
function updateWeightChart(data) {
    const ctx = document.getElementById('weightChart');
    if (!ctx) return;

    try {
        // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≥—Ä–∞—Ñ–∏–∫
        if (window.weightChart instanceof Chart) {
            window.weightChart.destroy();
        }

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
        window.weightChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(entry => {
                    const date = new Date(entry.date);
                    switch(window.currentPeriod) {
                        case 'week':
                            return date.toLocaleDateString('ru-RU', { weekday: 'short' });
                        case 'month':
                            return date.getDate();
                        case 'year':
                            return date.toLocaleDateString('ru-RU', { month: 'short' });
                        default:
                            return date.toLocaleDateString('ru-RU', { 
                                day: '2-digit', 
                                month: '2-digit' 
                            });
                    }
                }),
                datasets: [{
                    label: '–í–µ—Å (–∫–≥)',
                    data: data.map(entry => entry.weight),
                    borderColor: '#40a7e3',
                    backgroundColor: 'rgba(64, 167, 227, 0.1)',
                    fill: true,
                    tension: 0.4,
                    spanGaps: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: value => `${value} –∫–≥`,
                            font: { size: 10 }
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 10 } }
                    }
                },
                layout: {
                    padding: { left: 5, right: 5, top: 5, bottom: 5 }
                }
            }
        });

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã
        ctx.style.height = '150px';
        ctx.parentElement.style.height = '150px';

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
        try {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.period-btn').forEach(b => 
                b.classList.remove('active'));
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ
            btn.classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥ –∏ –≥—Ä–∞—Ñ–∏–∫
            currentPeriod = btn.dataset.period;
            const data = await getWeightData(currentPeriod);
            updateWeightChart(data);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
        }
    });
});

// –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
function setupTabHandlers() {
    const tabs = document.querySelectorAll('.tab-btn');
    const contents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', async () => {
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));

            tab.classList.add('active');
            const tabId = tab.dataset.tab;
            const tabContent = document.getElementById(tabId);
            tabContent.classList.add('active');

            // –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Å –ø—Ä–æ–≥—Ä–∞–º–º–∞–º–∏
            if (tabId === 'workouts') {
                setupProgramHandlers(); // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                mainButton.hide();
            } else if (tabId === 'profile' && window.profileData) {
                fillProfileForm(window.profileData);
                mainButton.setText('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å');
                mainButton.show();
            } else if (tabId === 'stats') {
                try {
                    const weightHistory = await getStorageItem('weightHistory')
                        .then(data => data ? JSON.parse(data) : []);
                    updateWeightChart(weightHistory);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ –≤–µ—Å–∞:', e);
                }
                mainButton.hide();
            } else {
                mainButton.hide();
            }

            tg.HapticFeedback.selectionChanged();
        });
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–∏–æ–¥–∞
    const periodButtons = document.querySelectorAll('.period-btn');
    periodButtons.forEach(button => {
        button.addEventListener('click', async () => {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            periodButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
            try {
                const weightHistory = await getStorageItem('weightHistory')
                    .then(data => data ? JSON.parse(data) : []);
                updateWeightChart(weightHistory, button.dataset.period);
                tg.HapticFeedback.selectionChanged();
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', e);
                showError(e);
            }
        });
    });
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
function setupEventListeners() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
    const form = document.getElementById('profile-form');
    const formInputs = form.querySelectorAll('input, select');
    formInputs.forEach(input => {
        input.addEventListener('input', () => {
            const hasData = Array.from(formInputs).some(input => input.value);
            if (hasData) {
                mainButton.show();
                backButton.hide();
            } else {
                mainButton.hide();
            }
        });
    });

    // –°–∫—Ä—ã—Ç–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    document.addEventListener('click', function(e) {
        if (!e.target.matches('input') && !e.target.matches('select')) {
            if (document.activeElement instanceof HTMLInputElement || 
                document.activeElement instanceof HTMLSelectElement) {
                document.activeElement.blur();
            }
        }
    });

    // –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª—è—Ö
    document.addEventListener('focus', function(e) {
        if (e.target.type === 'number') {
            e.target.select();
            tg.HapticFeedback.selectionChanged();
        }
    }, true);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ MainButton
    mainButton.onClick(saveProfile);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ BackButton
    backButton.onClick(() => {
        tg.close();
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    setupTabHandlers();

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ–ø–∞–ø–∞
    tg.onEvent('popupClosed', (button_id) => {
        if (button_id && button_id.startsWith('start_workout_')) {
            const [_, programId, day] = button_id.split('_').slice(2);
            startWorkout(programId, parseInt(day));
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('complete-btn')) {
            completeWorkout();
        } else if (e.target.classList.contains('pause-btn')) {
            toggleWorkoutPause();
        }
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤
    setupCheckboxHandlers();
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–∏–æ–¥–∞
function setupPeriodButtons() {
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            try {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                document.querySelectorAll('.period-btn').forEach(b => 
                    b.classList.remove('active'));
                btn.classList.add('active');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
                window.currentPeriod = btn.dataset.period;
                const data = await getWeightData(window.currentPeriod);
                if (data && data.length > 0) {
                    updateWeightChart(data);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä–∏–æ–¥–∞:', error);
            }
        });
    });
}

// –î–æ–±–∞–≤–∏–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
async function startWorkout(workoutId) {
    try {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å
        const profile = await getStorageItem('profile')
            .then(data => data ? JSON.parse(data) : null);
            
        if (!profile) {
            tg.showPopup({
                title: '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å',
                message: '–î–ª—è –Ω–∞—á–∞–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å',
                buttons: [
                    {
                        type: 'default',
                        text: '–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å',
                        id: 'fill_profile'
                    }
                ]
            });
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
        tg.showPopup({
            title: '–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É',
            message: '–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
            buttons: [
                {
                    type: 'default',
                    text: '–ù–∞—á–∞—Ç—å',
                    id: 'start_workout'
                },
                {
                    type: 'cancel',
                    text: '–û—Ç–º–µ–Ω–∞'
                }
            ]
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏:', error);
        showError(error);
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –¥–µ—Ç–∞–ª–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
function showWorkoutDetails(workoutId) {
    const workout = workoutData[workoutId];
    if (!workout) return;

    let detailsHtml = `
        <div class="workout-details-content">
            <h3>${workout.title}</h3>
            <p class="workout-description">${workout.description}</p>
            
            <div class="workout-info-grid">
                <div class="info-item">
                    <span class="material-symbols-rounded">schedule</span>
                    <span>${workout.duration} –º–∏–Ω</span>
                </div>
                <div class="info-item">
                    <span class="material-symbols-rounded">local_fire_department</span>
                    <span>${workout.calories} –∫–∫–∞–ª</span>
                </div>
                <div class="info-item">
                    <span class="material-symbols-rounded">fitness_center</span>
                    <span>${workout.difficulty}</span>
                </div>
            </div>`;

    if (workout.exercises) {
        detailsHtml += `
            <h4>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:</h4>
            <div class="exercises-list">
                ${workout.exercises.map(ex => `
                    <div class="exercise-item">
                        <h5>${ex.name}</h5>
                        <p>${ex.sets} –ø–æ–¥—Ö–æ–¥–∞ √ó ${ex.reps} –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π</p>
                        <p>–û—Ç–¥—ã—Ö: ${ex.rest} —Å–µ–∫</p>
                    </div>
                `).join('')}
            </div>`;
    }

    if (workout.intervals) {
        detailsHtml += `
            <h4>–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã:</h4>
            <div class="intervals-list">
                ${workout.intervals.map(int => `
                    <div class="interval-item">
                        <span>${int.type}</span>
                        <span>${int.duration} –º–∏–Ω - ${int.intensity}</span>
                    </div>
                `).join('')}
            </div>`;
    }

    detailsHtml += `
            <div class="workout-tips">
                <h4>–°–æ–≤–µ—Ç—ã:</h4>
                <ul>
                    ${workout.tips.map(tip => `<li>${tip}</li>`).join('')}
                </ul>
            </div>
        </div>
    `;

    tg.showPopup({
        title: '–î–µ—Ç–∞–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏',
        message: detailsHtml,
        buttons: [
            {type: 'default', text: '–ù–∞—á–∞—Ç—å', id: `start_${workoutId}`},
            {type: 'cancel', text: '–ó–∞–∫—Ä—ã—Ç—å'}
        ]
    });
}

// –û–±–Ω–æ–≤–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
function setupWorkoutHandlers() {
    document.querySelectorAll('.workout-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            const workoutCard = button.closest('.workout-card');
            const workoutTitle = workoutCard.querySelector('h3').textContent;
            const workoutId = getWorkoutIdByTitle(workoutTitle);
            
            if (button.classList.contains('info-btn')) {
                tg.HapticFeedback.impactOccurred('medium');
                showWorkoutDetails(workoutId);
            } else if (button.classList.contains('start-btn')) {
                tg.HapticFeedback.impactOccurred('medium');
                startWorkout(workoutId);
            }
        });
    });
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É
function getWorkoutIdByTitle(title) {
    return Object.keys(workoutData).find(key => 
        workoutData[key].title === title
    );
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –¥–µ—Ç–∞–ª–µ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
function showProgramDetails(programId) {
    const program = programData[programId];
    if (!program) return;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º –≤–∏–¥–µ
    const mainInfo = `
        <b>${program.title}</b>
        ${program.description}

        üìÖ ${program.schedule}
        üî• ${program.calories_per_week}
        üí™ –°–ª–æ–∂–Ω–æ—Å—Ç—å: ${program.difficulty}
    `;

    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–æ–ø–æ–∫ –¥–æ 3
    const buttons = [
        {
            id: `start_program_${programId}`,
            type: 'default',
            text: '–ù–∞—á–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É'
        },
        {
            id: `schedule_${programId}`,
            type: 'default',
            text: '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ'
        }
    ];

    tg.showPopup({
        title: program.title,
        message: mainInfo,
        buttons: buttons
    });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º—ã
function showProgramResults(programId) {
    const program = programData[programId];
    if (!program) return;

    const resultsInfo = program.results
        .map(result => `‚úÖ ${result}`)
        .join('\n');

    tg.showPopup({
        title: '–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã',
        message: resultsInfo,
        buttons: [
            {type: 'default', text: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥', id: `back_to_main_${programId}`},
            {type: 'default', text: '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ ‚ûú', id: `schedule_${programId}`},
            {type: 'default', text: '–ù–∞—á–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É', id: `start_program_${programId}`}
        ]
    });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã
function showProgramSchedule(programId) {
    const program = programData[programId];
    if (!program) return;

    const scheduleInfo = program.workouts
        .map(workout => `–î–µ–Ω—å ${workout.day}: ${workout.title}\n${workout.duration} –º–∏–Ω ‚Ä¢ ${workout.type}`)
        .join('\n\n');

    tg.showPopup({
        title: '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫',
        message: scheduleInfo,
        buttons: [
            {type: 'default', text: '‚¨ÖÔ∏è –ù–∞–∑–∞–¥', id: `back_to_main_${programId}`},
            {type: 'default', text: '–ù–∞—á–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É', id: `start_program_${programId}`}
        ]
    });
}

// –û–±–Ω–æ–≤–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –ø–æ–ø–∞–ø–∞
function setupPopupHandlers() {
    tg.onEvent('popupClosed', (event) => {
        console.log('Popup closed with event:', event);
        if (event && event.button_id) {
            if (event.button_id.startsWith('start_workout_')) {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º programId –∏ workoutDay –∏–∑ button_id
                const [_, __, programId, workoutDay] = event.button_id.split('_');
                console.log('Starting workout:', programId, workoutDay);
                startWorkoutSession(programId, parseInt(workoutDay));
            } else {
                const [action, ...params] = event.button_id.split('_');
                
                switch(action) {
                    case 'results':
                        showProgramResults(params[0]);
                        break;
                    case 'schedule':
                        showProgramSchedule(params[0]);
                        break;
                    case 'start':
                        if (params[0] === 'program') {
                            startProgram(params[1]);
                        }
                        break;
                    case 'back':
                        showProgramDetails(params[0]);
                        break;
                }
            }
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã
function updateProgramProgress(progress) {
    const programCard = document.querySelector(`.program-card[data-program="${progress.programId}"]`);
    if (!programCard) return;

    const progressBar = programCard.querySelector('.progress');
    const progressText = programCard.querySelector('.progress-text');
    
    if (progress.status === 'active') {
        // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        const program = programData[progress.programId];
        const totalWorkouts = program.workouts.length;
        const completedWorkouts = progress.completedWorkouts.length;
        const progressPercent = (completedWorkouts / totalWorkouts) * 100;

        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        if (progressBar) {
            progressBar.style.width = `${progressPercent}%`;
        }
        if (progressText) {
            progressText.textContent = `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${completedWorkouts}/${totalWorkouts} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫`;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        const startBtn = programCard.querySelector('.start-btn');
        if (startBtn) {
            startBtn.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
        }
    }
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é startProgram
async function startProgram(programId) {
    const program = programData[programId];
    if (!program) return;

    try {
        // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã
        const programProgress = {
            programId: programId,
            startDate: Date.now(),
            currentDay: 1,
            completedWorkouts: [],
            plannedWorkouts: []
        };

        // –ü–ª–∞–Ω–∏—Ä—É–µ–º –≤—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
        const startDate = new Date();
        for (const workout of program.workouts) {
            const workoutDate = new Date(startDate);
            workoutDate.setDate(workoutDate.getDate() + workout.day - 1);
            
            programProgress.plannedWorkouts.push({
                day: workout.day,
                plannedDate: workoutDate.getTime(),
                title: workout.title,
                duration: workout.duration,
                type: workout.type
            });
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        await setStorageItem('activeProgram', JSON.stringify(programProgress));

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        updateStatistics(programProgress);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        renderCalendar();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã
        await showPopupSafe({
            title: '–ü—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–∞—á–∞—Ç–∞!',
            message: `–í—ã –Ω–∞—á–∞–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º—É "${program.title}". –ü–µ—Ä–≤–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.`,
            buttons: [{
                type: 'default',
                text: '–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É',
                id: `start_workout_${programId}_1`
            }]
        });

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã:', error);
        showError(error);
    }
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é getStatistics
async function getStatistics() {
    try {
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ
        const [weightHistoryStr, activeProgramStr] = await Promise.all([
            getStorageItem('weightHistory'),
            getStorageItem('activeProgram')
        ]);

        // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ
        const weightHistory = weightHistoryStr ? JSON.parse(weightHistoryStr) : [];
        const activeProgram = activeProgramStr ? JSON.parse(activeProgramStr) : null;

        // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        const stats = {
            totalWorkouts: 0,
            totalMinutes: 0,
            totalCalories: 0,
            weightChange: 0,
            currentStreak: 0,
            longestStreak: 0
        };

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –≤–µ—Å–∞
        if (weightHistory.length > 1) {
            const sortedWeights = [...weightHistory].sort((a, b) => new Date(a.date) - new Date(b.date));
            const firstWeight = sortedWeights[0].weight;
            const lastWeight = sortedWeights[sortedWeights.length - 1].weight;
            stats.weightChange = +(lastWeight - firstWeight).toFixed(1);
        }

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã
        if (activeProgram?.completedWorkouts?.length > 0) {
            stats.totalWorkouts = activeProgram.completedWorkouts.length;
            
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∏–Ω—É—Ç—ã –∏ –∫–∞–ª–æ—Ä–∏–∏
            activeProgram.completedWorkouts.forEach(workout => {
                stats.totalMinutes += workout.duration || 0;
                stats.totalCalories += workout.calories || 0;
            });

            // –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å–µ—Ä–∏—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
            const today = new Date().setHours(0, 0, 0, 0);
            let currentStreak = 0;
            let maxStreak = 0;
            let lastWorkoutDate = null;

            const sortedWorkouts = [...activeProgram.completedWorkouts]
                .sort((a, b) => b.completedAt - a.completedAt);

            for (const workout of sortedWorkouts) {
                const workoutDate = new Date(workout.completedAt).setHours(0, 0, 0, 0);
                
                if (!lastWorkoutDate) {
                    currentStreak = 1;
                    lastWorkoutDate = workoutDate;
                } else {
                    const dayDiff = (lastWorkoutDate - workoutDate) / (1000 * 60 * 60 * 24);
                    
                    if (dayDiff === 1) {
                        currentStreak++;
                    } else {
                        maxStreak = Math.max(maxStreak, currentStreak);
                        currentStreak = 1;
                    }
                    lastWorkoutDate = workoutDate;
                }
            }

            stats.currentStreak = currentStreak;
            stats.longestStreak = Math.max(maxStreak, currentStreak);
        }

        return stats;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        return null;
    }
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é updateStatistics
async function updateStatistics() {
    try {
        const stats = await getStatistics();
        if (!stats) return;

        // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        const elements = {
            'total-workouts': stats.totalWorkouts || '0',
            'total-minutes': stats.totalMinutes || '0',
            'total-calories': stats.totalCalories || '0',
            'weight-change': stats.weightChange ? `${stats.weightChange > 0 ? '+' : ''}${stats.weightChange} –∫–≥` : '0 –∫–≥',
            'current-streak': `${stats.currentStreak || 0} –¥–Ω.`,
            'longest-streak': `${stats.longestStreak || 0} –¥–Ω.`
        };

        for (const [id, value] of Object.entries(elements)) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –≤–µ—Å–∞
        const weightData = await getWeightData(currentPeriod);
        if (weightData && weightData.length > 0) {
            updateWeightChart(weightData);
        } else {
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const chartContainer = document.getElementById('weight-chart-container');
            if (chartContainer) {
                chartContainer.innerHTML = '<div class="no-data-message">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤–µ—Å–µ</div>';
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
    }
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
async function initStatisticsPage() {
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Chart.js
        if (typeof Chart === 'undefined') {
            console.error('Chart.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
            return;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        await updateStatistics();

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–∏–æ–¥–∞
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                try {
                    document.querySelectorAll('.period-btn').forEach(b => 
                        b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    currentPeriod = btn.dataset.period;
                    const data = await getWeightData(currentPeriod);
                    if (data && data.length > 0) {
                        updateWeightChart(data);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞:', error);
                }
            });
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
    }
}

// –ó–∞–º–µ–Ω–∏–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ placeholder –Ω–∞ data URL
const defaultImage = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Crect width="100" height="100" fill="%23cccccc"/%3E%3Ctext x="50" y="50" font-family="Arial" font-size="14" fill="%23ffffff" text-anchor="middle" dy=".3em"%3E–ù–µ—Ç —Ñ–æ—Ç–æ%3C/text%3E%3C/svg%3E';

// –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –≤ –∫–æ–¥–µ –≤–º–µ—Å—Ç–æ via.placeholder.com
function updateProfilePhoto(photoUrl) {
    const profilePhoto = document.getElementById('profile-photo');
    if (profilePhoto) {
        profilePhoto.src = photoUrl || defaultImage;
        profilePhoto.onerror = () => {
            profilePhoto.src = defaultImage;
        };
    }
}

// –î–æ–±–∞–≤–∏–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ø–∞–ø–∞
async function showPopupSafe(options) {
    return new Promise((resolve) => {
        const showNext = async () => {
            if (popupQueue.length > 0 && !isPopupShowing) {
                isPopupShowing = true;
                const { options, resolver } = popupQueue[0];
                
                try {
                    const result = await tg.showPopup(options);
                    resolver(result);
                } catch (error) {
                    console.warn('–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –ø–æ–ø–∞–ø–∞:', error);
                    resolver(null);
                } finally {
                    isPopupShowing = false;
                    popupQueue.shift();
                    showNext();
                }
            }
        };

        popupQueue.push({ options, resolver: resolve });
        showNext();
    });
} 